name: Update Placement Data

on:
  schedule:
    - cron: '*/1 * * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      
      # REMOVED: Install jq step - it's already pre-installed!

      - name: Fetch and update data
        env:
          DASHBOARD_SCRIPT_URL: ${{ secrets.DASHBOARD_SCRIPT_URL }}
          DAY1_SCRIPT_URL: ${{ secrets.DAY1_SCRIPT_URL }}
          DAY2_SCRIPT_URL: ${{ secrets.DAY2_SCRIPT_URL }}
          DAY3_SCRIPT_URL: ${{ secrets.DAY3_SCRIPT_URL }}
        run: |
          mkdir -p data/companies

          echo "=== Fetching Dashboard main ==="
          curl -sL "${DASHBOARD_SCRIPT_URL}" > data/dashboard.json
          
          # Validate dashboard JSON
          if jq empty data/dashboard.json >/dev/null 2>&1; then
            echo "✓ Dashboard data fetched successfully"
          else
            echo "ERROR: Invalid dashboard JSON"
            cat data/dashboard.json
            exit 1
          fi

          fetch_day_data() {
            local day=$1
            local script_url=$2

            echo ""
            echo "=== Fetching Day ${day} main ==="
            
            # Check if URL is placeholder
            if [[ "$script_url" == "https://example.com" ]] || [[ "$script_url" == "" ]]; then
              echo "⚠ Day ${day} script not deployed yet - skipping"
              # Create empty placeholder files
              echo '{"day":'${day}',"available":false,"schedule":[]}' > "data/day${day}-schedule.json"
              echo '{"day":'${day}',"placements":[]}' > "data/day${day}-placed.json"
              echo '{"day":'${day}',"companies":[]}' > "data/day${day}-companies.json"
              return 0
            fi

            echo "Fetching schedule..."
            curl -sL "${script_url}?action=schedule" > "data/day${day}-schedule.json"

            echo "Fetching placed candidates..."
            curl -sL "${script_url}?action=placed" > "data/day${day}-placed.json"

            echo "Fetching company list..."
            curl -sL "${script_url}?action=companies" > "data/day${day}-companies.json"

            echo "Validating company list JSON..."
            if ! jq empty "data/day${day}-companies.json" >/dev/null 2>&1; then
              echo "ERROR: Invalid JSON received for company list (Day ${day})"
              echo "Response content:"
              cat "data/day${day}-companies.json"
              echo "⚠ Skipping company data fetch for Day ${day}"
              return 0
            fi

            echo "Extracting company names..."
            companies=$(jq -r '.companies[]' "data/day${day}-companies.json" 2>/dev/null)

            if [ -z "$companies" ]; then
              echo "⚠ No companies found for Day ${day}"
            else
              echo "✓ Companies found for Day ${day}:"
              echo "$companies"

              for company in $companies; do
                encoded_company=$(printf '%s' "$company" | jq -sRr @uri)

                echo "  → Fetching: ${company}"
                curl -sL "${script_url}?action=company&name=${encoded_company}" \
                  > "data/companies/day${day}-${company}.json"

                sleep 0.5
              done
            fi

            echo "✓ Day ${day} data fetch completed"
          }

          fetch_day_data 1 "${DAY1_SCRIPT_URL}"
          fetch_day_data 2 "${DAY2_SCRIPT_URL}"
          fetch_day_data 3 "${DAY3_SCRIPT_URL}"

          echo ""
          echo "=== All Data Fetched Successfully ==="
          echo "Fetch completed at $(date)"

          echo ""
          echo "=== Generated Files ==="
          ls -lh data/ 2>/dev/null || echo "No files in data/"
          echo ""
          echo "=== Company Files ==="
          ls -lh data/companies/ 2>/dev/null | head -20 || echo "No company files yet"

      - name: Commit and force push
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add data/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update placement data - $(date '+%Y-%m-%d %H:%M:%S')"
            git push origin main --force
            echo "✓ Data updated and pushed successfully"
          fi
