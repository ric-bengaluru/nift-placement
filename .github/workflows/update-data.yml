name: Update Placement Data

on:
  schedule:
    - cron: '*/1 * * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Data branch
        uses: actions/checkout@v3
        with:
          ref: Data
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Fetch and update data
        env:
          DASHBOARD_SCRIPT_URL: ${{ secrets.DASHBOARD_SCRIPT_URL }}
          DAY1_SCRIPT_URL: ${{ secrets.DAY1_SCRIPT_URL }}
          DAY2_SCRIPT_URL: ${{ secrets.DAY2_SCRIPT_URL }}
          DAY3_SCRIPT_URL: ${{ secrets.DAY3_SCRIPT_URL }}
        run: |
          mkdir -p data/companies

          echo "=== Fetching Dashboard Data ==="
          curl -s "${DASHBOARD_SCRIPT_URL}" > data/dashboard.json
          echo "Dashboard data fetched"

          fetch_day_data() {
            local day=$1
            local script_url=$2

            echo "=== Fetching Day ${day} Data ==="

            echo "Fetching schedule..."
            curl -s "${script_url}?action=schedule" > "data/day${day}-schedule.json"

            echo "Fetching placed candidates..."
            curl -s "${script_url}?action=placed" > "data/day${day}-placed.json"

            echo "Fetching company list..."
            curl -s "${script_url}?action=companies" > "data/day${day}-companies.json"

            echo "Extracting company names..."
            companies=$(jq -r '.companies[]' "data/day${day}-companies.json")

            echo "Companies found for Day ${day}:"
            echo "$companies"

            for company in $companies; do
              encoded_company=$(printf '%s' "$company" | jq -sRr @uri)

              echo "Fetching company data: day${day}-${company}"
              curl -s "${script_url}?action=company&name=${encoded_company}" \
                > "data/companies/day${day}-${company}.json"

              sleep 0.5
            done

            echo "Day ${day} data fetch completed"
          }

          fetch_day_data 1 "${DAY1_SCRIPT_URL}"
          fetch_day_data 2 "${DAY2_SCRIPT_URL}"
          fetch_day_data 3 "${DAY3_SCRIPT_URL}"

          echo "=== All Data Fetched Successfully ==="
          echo "Fetch completed at $(date)"

          echo "=== Generated Files ==="
          ls -lh data/
          ls -lh data/companies/ | head -20

      - name: Commit and force push
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add data/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update placement data - $(date '+%Y-%m-%d %H:%M:%S')"
            git push origin Data --force
            echo "Data updated and pushed successfully"
          fi
